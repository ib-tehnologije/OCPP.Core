@model OCPP.Core.Management.Models.PublicStartViewModel
@inject Microsoft.Extensions.Configuration.IConfiguration Config

@{
    Layout = null;
    ViewData["Title"] = "Start charging";
    var brandName = Config["PublicPortal:BrandName"] ?? "OCPP Core";
    var brandTagline = Config["PublicPortal:Tagline"] ?? "Start your EV session in one step.";
    var chargePointLabel = string.IsNullOrWhiteSpace(Model.ChargePointName)
        ? Model.ChargePointId
        : Model.ChargePointName;
    var connectorLabel = string.IsNullOrWhiteSpace(Model.ConnectorName)
        ? $"Connector {Model.ConnectorId}"
        : Model.ConnectorName;
    var badgeClass = "waiting";
    if (string.Equals(Model.LastStatus, "Available", StringComparison.OrdinalIgnoreCase)) badgeClass = "available";
    if (string.Equals(Model.LastStatus, "Faulted", StringComparison.OrdinalIgnoreCase)) badgeClass = "error";
    var isFree = Model.FreeChargingEnabled || (Model.PricePerKwh <= 0 && Model.ConnectorUsageFeePerMinute <= 0 && Model.UserSessionFee <= 0);
    var mapUrl = Url.Action("Index", "Public");
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Start charging - @chargePointLabel</title>
    <link rel="stylesheet" href="~/css/public-portal.css" />
</head>
<body class="public-portal">
    <nav class="public-session-nav" aria-label="Charging session states">
        <button type="button" class="active" disabled>‚ë† Start</button>
        <button type="button" disabled>‚ë° Wait</button>
        <button type="button" disabled>‚ë¢ Charge</button>
        <button type="button" disabled>‚ë£ Done</button>
        <button type="button" disabled>‚ë§ Error</button>
    </nav>
    <div class="lang-bar">
        <span class="lbl">üåê</span>
        <button type="button" class="lang-btn active">EN</button>
        <button type="button" class="lang-btn">HR</button>
        <button type="button" class="lang-btn">DE</button>
        <button type="button" class="lang-btn">IT</button>
    </div>

    <div class="page-wrap">
        <div class="card">
            <div class="brand-bar">
                <div class="brand-logo">‚ö°</div>
                <div class="brand-name">@brandName</div>
            </div>

            <div class="status-header">
                <div class="status-badge @badgeClass">
                    <span class="dot"></span>
                    <span>@(isFree ? "Free charging" : (string.IsNullOrWhiteSpace(Model.LastStatus) ? "Available" : Model.LastStatus))</span>
                </div>
                <h1 class="charger-title">@chargePointLabel</h1>
                <p class="charger-sub">@connectorLabel</p>
            </div>

            <div class="divider"></div>

            <div class="info-section">
                <div class="info-section-title">Prices & fees</div>
                <div class="info-row">
                    <div class="tile featured">
                        <div class="label">Energy</div>
                        <div class="value">
                            @if (Model.PricePerKwh > 0)
                            {
                                <span>@Model.PricePerKwh.ToString("0.##")</span><span class="unit">@Model.CurrencySymbol/kWh</span>
                            }
                            else
                            {
                                <span class="highlight">Free</span><span class="unit">energy</span>
                            }
                        </div>
                    </div>
                    <div class="tile">
                        <div class="label">Session fee</div>
                        <div class="value">
                            @if (Model.UserSessionFee > 0)
                            {
                                <span>@Model.UserSessionFee.ToString("0.##")</span><span class="unit">@Model.CurrencySymbol</span>
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </div>
                    </div>
                </div>

                <div class="info-row">
                    <div class="tile full" style="border-color: var(--warning-border); background: var(--warning-bg);">
                        <div class="label" style="color: var(--warning);">‚è± Idle fee</div>
                        <div class="value">
                            @if (Model.ConnectorUsageFeePerMinute > 0)
                            {
                                <span>@Model.ConnectorUsageFeePerMinute.ToString("0.##")</span><span class="unit">@Model.CurrencySymbol/min</span>
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </div>
                        @if (Model.ConnectorUsageFeePerMinute > 0)
                        {
                            <div class="sub" style="color:#fde68a;">
                                @(Model.UsageFeeAfterChargingEnds ? "Charged after charging ends" : "Charged from session start") ¬∑ grace @Model.StartUsageFeeAfterMinutes min ¬∑ max @Model.MaxUsageFeeBillableMinutes min
                            </div>
                        }
                    </div>
                </div>

                <div class="info-row">
                    <div class="tile">
                        <div class="label">Max. energy</div>
                        <div class="value">
                            @if (Model.MaxSessionKwh > 0)
                            {
                                <span>@Model.MaxSessionKwh.ToString("0.#")</span><span class="unit">kWh</span>
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </div>
                    </div>
                    <div class="tile">
                        <div class="label">Pre-authorization (est.)</div>
                        <div class="value">
                            @if (Model.EstimatedMaxHold > 0)
                            {
                                <span>@Model.EstimatedMaxHold.ToString("0.##")</span><span class="unit">@Model.CurrencySymbol</span>
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </div>
                    </div>
                </div>

                <div class="info-row">
                    <div class="tile full" style="background: transparent; border-style: dashed;">
                        <div class="sub" style="margin:0;">üí° Final amount = energy + session fee + idle fee (if any). Difference from pre-auth is refunded automatically.</div>
                    </div>
                </div>
            </div>

            <div class="divider"></div>

            <div class="form-section">
                <form method="post" asp-action="Start">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="ChargePointId" value="@Model.ChargePointId" />
                    <input type="hidden" name="ConnectorId" value="@Model.ConnectorId" />

                    <label class="r1-checkbox">
                        <input type="checkbox" id="wantsR1">
                        <div class="r1-label">
                            <strong>Company invoice</strong>
                            <span class="r1-hint">Company details are entered later via email link.</span>
                        </div>
                    </label>

                    <label for="chargeTagId" class="field-label">Charge tag / RFID (optional)</label>
                    <input type="text" class="field-input" id="chargeTagId" name="ChargeTagId" value="@Model.ChargeTagId" placeholder="Have a card? Enter it here" @(Model.HasError ? "" : "autofocus") />
                    <div class="field-help">Leave blank to auto-generate a temporary tag for this start.</div>

                    <button type="submit" class="btn-primary" @(Model.HasError ? "disabled" : "")>
                        <span>@(isFree ? "Start free session" : "Start charging")</span>
                        <span class="arrow" aria-hidden="true">‚Üí</span>
                    </button>

                    <a class="btn-secondary" href="@mapUrl">Back to map</a>
                </form>
            </div>

            @if (Model.HasError)
            {
                <div class="alert-box danger" style="margin-bottom:0;border-radius:0;border-left:none;border-right:none;border-bottom:none;">
                    <span class="alert-icon">‚ö†Ô∏è</span>
                    <span>@Model.ErrorMessage</span>
                </div>
            }
            else
            {
                <div class="alert-box info" style="margin-bottom:0;border-radius:0;border-left:none;border-right:none;border-bottom:none;">
                    <span class="alert-icon">üîí</span>
                    <span>@(Model.FreeChargingEnabled ? "Free charging enabled. No payment will be charged." : "Secure payment via Stripe. Only the actual cost is charged.")</span>
                </div>
            }
        </div>
    </div>
</body>
</html>
