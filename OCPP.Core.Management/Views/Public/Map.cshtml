@model OCPP.Core.Management.Models.PublicMapViewModel
@inject Microsoft.Extensions.Configuration.IConfiguration Config
@{
    Layout = null;
    ViewData["Title"] = "Charging locations";
    var hasCoords = Model.ChargePoints?.Any(cp => cp.Latitude.HasValue && cp.Longitude.HasValue) == true;
    var brandName = Config["PublicPortal:BrandName"] ?? "OCPP Core";
    var brandTagline = Config["PublicPortal:Tagline"] ?? "Fast charging locations for your EV.";
    var isMapPage = string.Equals(ViewContext?.RouteData?.Values["action"]?.ToString(), "Map", StringComparison.OrdinalIgnoreCase);
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Charging locations</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="~/css/public-portal.css" />
</head>
<body class="public-portal">
    <main class="public-shell">
        <header class="public-header">
            <div class="public-branding">
                <div class="public-badge">‚ö°</div>
                <div class="public-brand-text">
                    <h1 class="public-brand-title">@brandName</h1>
                    <p class="public-brand-sub">@brandTagline</p>
                </div>
            </div>
        </header>
        <nav class="public-portal-nav">
            <a class="public-nav-link @(isMapPage ? "active" : "")" href="@Url.Action("Index", "Public")">‚ë† Map</a>
            <a class="public-nav-link @(!isMapPage ? "active" : "")" href="@Url.Action("Start", "Public")">‚ë° Start</a>
        </nav>
        <div class="public-lang-bar">
            <span class="public-lang-label">üåê</span>
            <button type="button" class="public-lang-btn is-active">EN</button>
            <button type="button" class="public-lang-btn">HR</button>
            <button type="button" class="public-lang-btn">DE</button>
            <button type="button" class="public-lang-btn">IT</button>
        </div>

        <div class="public-grid">
            <section class="public-card">
                <div class="public-top">
                    <h2 class="public-section-title">Charging map</h2>
                    <p class="public-section-sub">Tap a station for details and start a session.</p>
                </div>

                <div class="public-toolbar">
                    <input type="search" id="searchInput" class="public-search" placeholder="Search by name or location" />
                    <button type="button" id="clearSearch" class="public-btn ghost">Clear</button>
                    <span class="public-stat">@Model.ChargePoints.Count station(s)</span>
                </div>

                <div class="public-list-grid" id="cpList">
                    @if (Model.ChargePoints.Count == 0)
                    {
                        <div class="public-empty-state">No stations configured yet.</div>
                    }
                    else
                    {
                        foreach (var cp in Model.ChargePoints)
                        {
                            var statusClass = "open";
                            if (string.Equals(cp.Status, "Faulted", StringComparison.InvariantCultureIgnoreCase))
                            {
                                statusClass = "faulted";
                            }
                            else if (!string.Equals(cp.Status, "Available", StringComparison.InvariantCultureIgnoreCase))
                            {
                                statusClass = "occupied";
                            }
                            var searchText = $"{cp.Name} {cp.LocationDescription} {cp.ChargePointId}";
                            <div class="public-list-item cp-card" data-search="@searchText" data-cp-id="@cp.ChargePointId">
                            <div class="public-status-pill @statusClass">
                                <span class="status-dot"></span>
                                @cp.Status
                            </div>
                                <h3 style="margin: 8px 0 4px;">@cp.Name</h3>
                                <p class="public-tile-help">@cp.LocationDescription</p>
                                <p class="public-tile-help">@cp.ConnectorCount connector(s)</p>
                                <p class="public-tile-help">
                                    @if (cp.PricePerKwh > 0)
                                    {
                                        <span>@cp.PricePerKwh.ToString("0.##") @Model.CurrencySymbol / kWh</span>
                                    }
                                    else
                                    {
                                        <span>Free energy</span>
                                    }
                                </p>
                                @if (cp.ConnectorUsageFeePerMinute > 0)
                                {
                                    <p class="public-tile-help">Idle fee: @cp.ConnectorUsageFeePerMinute.ToString("0.##") @Model.CurrencySymbol/min (@(cp.UsageFeeAfterChargingEnds ? "after charge" : "from start"), grace @cp.StartUsageFeeAfterMinutes min)</p>
                                }
                                <a class="public-btn" href="@Url.Action("Start", "Public", new { cp = cp.ChargePointId, conn = 1 })">Start session</a>
                            </div>
                        }
                    }
                </div>
            </section>

            <section class="public-card public-map-card">
                @if (hasCoords)
                {
                    <div class="public-map-wrap">
                        <div id="map" class="public-map" style="height: 100%; min-height: 360px; width: 100%;"></div>
                    </div>
                }
                else
                {
                    <div class="public-empty-state">No map data available (missing coordinates).</div>
                }
            </section>
        </div>
    </main>

    @if (hasCoords)
    {
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script>
            const points = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.ChargePoints ?? new List<PublicMapChargePoint>()));
            if (typeof L === 'undefined' || typeof L.map !== 'function') {
                console.error('Public map: Leaflet library failed to load.');
            } else {
            const map = L.map('map');
            const startUrlBase = '@Url.Action("Start", "Public")';
            const listEl = document.getElementById('cpList');
            const searchInput = document.getElementById('searchInput');
            const clearSearch = document.getElementById('clearSearch');
            const markerLookup = {};

            const pick = (obj, primary, secondary) => {
                if (obj[primary] !== undefined && obj[primary] !== null) return obj[primary];
                if (obj[secondary] !== undefined && obj[secondary] !== null) return obj[secondary];
                return '';
            };

            const asNumber = (value) => {
                const num = Number(value);
                return Number.isFinite(num) ? num : null;
            };

            const hasLocation = points.filter(p => {
                const lat = asNumber(pick(p, 'Latitude', 'latitude'));
                const lng = asNumber(pick(p, 'Longitude', 'longitude'));
                return lat !== null && lng !== null;
            });

            if (hasLocation.length > 0) {
                const bounds = L.latLngBounds(hasLocation.map(p => [pick(p, 'Latitude', 'latitude'), pick(p, 'Longitude', 'longitude')]));
                map.fitBounds(bounds.pad(0.2));
            } else {
                map.setView([0, 0], 2);
                const mapRoot = document.getElementById('map');
                if (mapRoot) {
                    mapRoot.insertAdjacentHTML('beforeend', '<div class="public-empty-state">No usable coordinates were found for map markers.</div>');
                }
            }

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            hasLocation.forEach(p => {
                const chargePointId = pick(p, 'ChargePointId', 'chargePointId');
                const name = (pick(p, 'Name', 'name') || '').trim() || '(Unnamed station)';
                const status = (pick(p, 'Status', 'status') || '').toLowerCase();
                let color = '#00d4aa';
                if (status.includes('fault')) {
                    color = '#ff6477';
                } else if (!status.includes('avail')) {
                    color = '#ffc107';
                }

                const lat = asNumber(pick(p, 'Latitude', 'latitude'));
                const lng = asNumber(pick(p, 'Longitude', 'longitude'));
                const marker = L.circleMarker([lat, lng], {
                    radius: 8,
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.85,
                    weight: 1
                }).addTo(map);

                const price = pick(p, 'PricePerKwh', 'pricePerKwh');
                const usageFee = pick(p, 'ConnectorUsageFeePerMinute', 'connectorUsageFeePerMinute');
                const startFeeTime = pick(p, 'StartUsageFeeAfterMinutes', 'startUsageFeeAfterMinutes');
                const afterCharge = pick(p, 'UsageFeeAfterChargingEnds', 'usageFeeAfterChargingEnds');
                const safePrice = Number(price) > 0 ? `${Number(price).toFixed(2)} @Model.CurrencySymbol / kWh` : 'Free energy';
                const idleText = usageFee > 0
                    ? `<br/>Idle fee: ${Number(usageFee).toFixed(2)} @Model.CurrencySymbol/min (${afterCharge ? 'after charge' : 'from start'}, grace ${startFeeTime} min)`
                    : '';
                const startUrl = `${startUrlBase}?cp=${encodeURIComponent(chargePointId)}&conn=1`;

                marker.bindPopup(`<strong>${escapeHtml(name)}</strong><br/>${safePrice}${idleText}<br/><a class="public-btn" href="${startUrl}">Start session</a>`);
                markerLookup[chargePointId] = marker;

                marker.on('click', () => {
                    const card = findCardByCpId(chargePointId);
                    if (card) {
                        card.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                        card.classList.add('active');
                        setTimeout(() => card.classList.remove('active'), 900);
                    }
                });
            });

            function escapeHtml(value) {
                return String(value || '').replace(/[&<>"']/g, match => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match]);
            }

            function filterMapAndList(query) {
                const term = (query || '').toLowerCase();
                const cards = document.querySelectorAll('.cp-card');
                const visibleMarkers = [];

                cards.forEach(card => {
                    const text = (card.dataset.search || '').toLowerCase();
                    const match = term.length === 0 || text.indexOf(term) >= 0;
                    card.style.display = match ? '' : 'none';

                    const cpId = card.dataset.cpId;
                    const marker = cpId ? markerLookup[cpId] : null;
                    if (marker) {
                        if (match) {
                            marker.addTo(map);
                            visibleMarkers.push(marker.getLatLng());
                        } else {
                            map.removeLayer(marker);
                        }
                    }
                });

                if (visibleMarkers.length > 0) {
                    const bounds = L.latLngBounds(visibleMarkers);
                    map.fitBounds(bounds.pad(0.2));
                }
            }

            function findCardByCpId(cpId) {
                const cards = document.querySelectorAll('.cp-card');
                for (const card of cards) {
                    if (card.dataset && card.dataset.cpId === cpId) {
                        return card;
                    }
                }
                return null;
            }

            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    filterMapAndList(this.value);
                });
            }

            if (clearSearch) {
                clearSearch.addEventListener('click', function () {
                    if (searchInput) {
                        searchInput.value = '';
                        filterMapAndList('');
                        searchInput.focus();
                    }
                });
            }

            if (listEl) {
                listEl.addEventListener('click', function (ev) {
                    const card = ev.target.closest('.cp-card');
                    if (!card || !card.dataset) return;
                    const cpId = card.dataset.cpId;
                    const marker = markerLookup[cpId];
                    if (!marker) return;
                    const latlng = marker.getLatLng();
                    map.flyTo([latlng.lat, latlng.lng], 16, { animate: true, duration: 0.45 });
                    marker.openPopup();
                });
            }

            const hasFiniteCoordinates = Object.keys(markerLookup).length > 0;
            if (!hasFiniteCoordinates) {
                console.error('Public map: no finite coordinates found in marker list.');
            }

            requestAnimationFrame(() => {
                map.invalidateSize();
                if (hasLocation.length > 0) {
                    const bounds = L.latLngBounds(hasLocation.map(p => [asNumber(pick(p, 'Latitude', 'latitude')), asNumber(pick(p, 'Longitude', 'longitude'))]));
                    map.fitBounds(bounds.pad(0.2));
                }
            });

            filterMapAndList('');
            window.addEventListener('resize', () => map.invalidateSize());
            }
        </script>
    }
</body>
</html>
