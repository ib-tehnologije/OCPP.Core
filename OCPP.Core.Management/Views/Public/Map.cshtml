@model OCPP.Core.Management.Models.PublicMapViewModel
@inject Microsoft.Extensions.Configuration.IConfiguration Config
@{
    Layout = null;
    ViewData["Title"] = "Charging map";
    var hasCoords = Model.ChargePoints?.Any(cp => cp.Latitude.HasValue && cp.Longitude.HasValue) == true;
    var brandName = Config["PublicPortal:BrandName"] ?? "OCPP Core";
    var brandTagline = Config["PublicPortal:Tagline"] ?? "Fast charging locations for your EV.";
    var supportEmail = Config["PublicPortal:SupportEmail"] ?? Config["Email:ReplyToAddress"] ?? Config["Email:FromAddress"];
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Charging map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="~/css/public-portal.css" />
</head>
<body class="public-portal">
    <div class="page-wrap" style="align-items: flex-start; padding-top: 20px;">
        <div class="map-container">
            <div class="card" style="width: 100%; max-width: none;">
                <div class="brand-bar">
                    <div class="brand-logo">‚ö°</div>
                    <div class="brand-name">@brandName</div>
                </div>

                <div class="map-header">
                    <h2>Charging map</h2>
                    <div class="charger-count"><span>@Model.ChargePoints.Count</span> station(s)</div>
                </div>

                <div style="padding: 0 24px;">
                    @if (hasCoords)
                    {
                        <div style="position: relative;">
                            <button id="gpsBtn" type="button" title="Center on your location"
                                    style="position:absolute;right:10px;top:10px;z-index:999;padding:7px 14px;border-radius:10px;background:var(--surface);border:1px solid var(--border);color:var(--accent);font:500 0.82rem var(--font);cursor:pointer;display:flex;align-items:center;gap:6px;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);transition:all 0.2s;box-shadow:0 2px 8px rgba(0,0,0,0.2);">
                                üìç GPS
                            </button>
                            <button id="mapExpandBtn" type="button" title="Expand map"
                                    style="position:absolute;right:10px;top:48px;z-index:999;padding:7px 14px;border-radius:10px;background:var(--surface);border:1px solid var(--border);color:var(--accent);font:500 0.82rem var(--font);cursor:pointer;display:flex;align-items:center;gap:6px;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);transition:all 0.2s;box-shadow:0 2px 8px rgba(0,0,0,0.2);">
                                üó∫ Expand
                            </button>
                            <div id="map"></div>
                        </div>
                    }
                    else
                    {
                        <div class="alert-box warning" style="margin: 0 0 16px;">
                            <span class="alert-icon">üó∫Ô∏è</span>
                            <span>No map data available (missing coordinates).</span>
                        </div>
                    }
                </div>

                <div class="map-legend">
                    <div class="legend-item"><div class="legend-dot online"></div><span>Available</span></div>
                    <div class="legend-item"><div class="legend-dot busy"></div><span>Busy</span></div>
                    <div class="legend-item"><div class="legend-dot offline"></div><span>Offline</span></div>
                </div>

                <div class="map-search-wrap">
                    <div class="map-search">
                        <span class="map-search-icon">üîç</span>
                        <input type="text" id="mapSearch" placeholder="Search by name, location, or charge point id..." autocomplete="off" />
                        <button type="button" class="map-search-clear" id="mapSearchClear" aria-label="Clear search">&times;</button>
                    </div>
                </div>

                <div class="divider"></div>

                <div style="padding: 16px 24px 8px;">
                    <div class="info-section-title">Stations on map</div>
                </div>

                <div class="charger-list" id="charger-list">
                    @if (Model.ChargePoints.Count == 0)
                    {
                        <div class="tile full" style="grid-column: 1 / -1;">
                            <div class="label">No stations configured yet.</div>
                        </div>
                    }
                    else
                    {
                        foreach (var cp in Model.ChargePoints)
                        {
                            var statusClass = "busy";
                            if (string.Equals(cp.Status, "Available", StringComparison.InvariantCultureIgnoreCase))
                            {
                                statusClass = "online";
                            }
                            else if (string.Equals(cp.Status, "Faulted", StringComparison.InvariantCultureIgnoreCase) ||
                                     string.Equals(cp.Status, "Unavailable", StringComparison.InvariantCultureIgnoreCase))
                            {
                                statusClass = "offline";
                            }

                            var searchText = $"{cp.Name} {cp.LocationDescription} {cp.ChargePointId}";
                            <div class="charger-card cp-card" data-search="@searchText" data-cp-id="@cp.ChargePointId">
                                <div class="cc-top">
                                    <div class="cc-name">@cp.Name</div>
                                    <div class="cc-status @statusClass">@cp.Status</div>
                                </div>
                                <div class="cc-detail">@cp.LocationDescription</div>
                                <div class="cc-detail">@cp.ConnectorCount connector(s)</div>
                                <div class="cc-detail">
                                    @if (cp.PricePerKwh > 0)
                                    {
                                        <span class="cc-power">@cp.PricePerKwh.ToString("0.##") @Model.CurrencySymbol / kWh</span>
                                    }
                                    else
                                    {
                                        <span class="cc-power">Free energy</span>
                                    }
                                    @if (cp.UserSessionFee > 0)
                                    {
                                        <span> ¬∑ Session fee @cp.UserSessionFee.ToString("0.##") @Model.CurrencySymbol</span>
                                    }
                                </div>
                                @if (cp.ConnectorUsageFeePerMinute > 0)
                                {
                                    <div class="cc-detail">Idle fee @cp.ConnectorUsageFeePerMinute.ToString("0.##") @Model.CurrencySymbol/min (grace @cp.StartUsageFeeAfterMinutes min)</div>
                                }
                                <div class="cc-actions">
                                    <a href="@Url.Action("Start", "Public", new { cp = cp.ChargePointId, conn = 1 })" onclick="event.stopPropagation();">Start session</a>
                                </div>
                            </div>
                        }
                    }
                </div>

                <div class="company-footer">
                    <div class="company-footer-brand">@brandName</div>
                    @if (!string.IsNullOrWhiteSpace(brandTagline))
                    {
                        <div class="company-footer-info">@brandTagline</div>
                    }
                    @if (!string.IsNullOrWhiteSpace(supportEmail))
                    {
                        <div class="company-footer-links">
                            <a href="mailto:@supportEmail">@supportEmail</a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    @if (hasCoords)
    {
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script>
            const points = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.ChargePoints ?? new List<PublicMapChargePoint>()));
            const currencySymbol = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.CurrencySymbol));
            if (typeof L === 'undefined' || typeof L.map !== 'function') {
                console.error('Public map: Leaflet library failed to load.');
            } else {
            const map = L.map('map');
            const startUrlBase = '@Url.Action("Start", "Public")';
            const listEl = document.getElementById('charger-list');
            const searchInput = document.getElementById('mapSearch');
            const clearSearch = document.getElementById('mapSearchClear');
            const gpsBtn = document.getElementById('gpsBtn');
            const mapExpandBtn = document.getElementById('mapExpandBtn');
            const markerLookup = {};
            let userMarker = null;

            const pick = (obj, primary, secondary) => {
                if (obj[primary] !== undefined && obj[primary] !== null) return obj[primary];
                if (obj[secondary] !== undefined && obj[secondary] !== null) return obj[secondary];
                return '';
            };

            const asNumber = (value) => {
                if (value === null || value === undefined) return null;
                if (typeof value === 'string') {
                    const trimmed = value.trim();
                    if (trimmed.length === 0) return null;
                    value = trimmed;
                }
                const num = Number(value);
                return Number.isFinite(num) ? num : null;
            };

            const hasLocation = points.filter(p => {
                const lat = asNumber(pick(p, 'Latitude', 'latitude'));
                const lng = asNumber(pick(p, 'Longitude', 'longitude'));
                return lat !== null && lng !== null;
            });

            if (hasLocation.length > 0) {
                const bounds = L.latLngBounds(hasLocation.map(p => [asNumber(pick(p, 'Latitude', 'latitude')), asNumber(pick(p, 'Longitude', 'longitude'))]));
                map.fitBounds(bounds.pad(0.2));
            } else {
                map.setView([0, 0], 2);
                const mapRoot = document.getElementById('map');
                if (mapRoot) {
                    mapRoot.insertAdjacentHTML('beforeend', '<div class="public-empty-state">No usable coordinates were found for map markers.</div>');
                }
            }

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            hasLocation.forEach(p => {
                const chargePointId = pick(p, 'ChargePointId', 'chargePointId');
                const name = (pick(p, 'Name', 'name') || '').trim() || '(Unnamed station)';
                const status = (pick(p, 'Status', 'status') || '').toLowerCase();
                let color = '#00d4aa';
                let statusLabel = pick(p, 'Status', 'status') || 'Unknown';
                if (status.includes('fault') || status.includes('unavail') || status.includes('offline')) {
                    color = '#ff6b81';
                } else if (!status.includes('avail')) {
                    color = '#a78bfa';
                }

                const lat = asNumber(pick(p, 'Latitude', 'latitude'));
                const lng = asNumber(pick(p, 'Longitude', 'longitude'));
                const marker = L.circleMarker([lat, lng], {
                    radius: 8,
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.85,
                    weight: 1
                }).addTo(map);

                const price = pick(p, 'PricePerKwh', 'pricePerKwh');
                const usageFee = pick(p, 'ConnectorUsageFeePerMinute', 'connectorUsageFeePerMinute');
                const startFeeTime = pick(p, 'StartUsageFeeAfterMinutes', 'startUsageFeeAfterMinutes');
                const afterCharge = pick(p, 'UsageFeeAfterChargingEnds', 'usageFeeAfterChargingEnds');
                const safePrice = Number(price) > 0 ? `${Number(price).toFixed(2)} ${currencySymbol} / kWh` : 'Free energy';
                const idleText = usageFee > 0
                    ? `Idle fee: ${Number(usageFee).toFixed(2)} ${currencySymbol}/min (${afterCharge ? 'after charge' : 'from start'}, grace ${startFeeTime} min)`
                    : null;
                const startUrl = `${startUrlBase}?cp=${encodeURIComponent(chargePointId)}&conn=1`;

                const addr = (pick(p, 'LocationDescription', 'locationDescription') || '').trim();
                const popupHtml = [
                    `<div class="popup-name">${escapeHtml(name)}</div>`,
                    addr ? `<div class="popup-addr">${escapeHtml(addr)}</div>` : '',
                    `<div class="popup-status">${escapeHtml(statusLabel)}</div>`,
                    `<div><span class="popup-power">${escapeHtml(safePrice)}</span></div>`,
                    idleText ? `<div class="popup-status">${escapeHtml(idleText)}</div>` : '',
                    `<div style="margin-top: 10px;"><a class="btn-secondary" style="margin-top:0;" href="${startUrl}">Start session ‚Üí</a></div>`
                ].filter(Boolean).join('');
                marker.bindPopup(popupHtml);
                markerLookup[chargePointId] = marker;

                marker.on('click', () => {
                    const card = findCardByCpId(chargePointId);
                    if (card) {
                        card.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                        card.classList.add('active');
                        setTimeout(() => card.classList.remove('active'), 900);
                    }
                });
            });

            function escapeHtml(value) {
                return String(value || '').replace(/[&<>"']/g, match => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match]));
            }

            function filterMapAndList(query) {
                const term = (query || '').toLowerCase();
                const cards = document.querySelectorAll('.cp-card');
                const visibleMarkers = [];

                cards.forEach(card => {
                    const text = (card.dataset.search || '').toLowerCase();
                    const match = term.length === 0 || text.indexOf(term) >= 0;
                    card.style.display = match ? '' : 'none';

                    const cpId = card.dataset.cpId;
                    const marker = cpId ? markerLookup[cpId] : null;
                    if (marker) {
                        if (match) {
                            marker.addTo(map);
                            visibleMarkers.push(marker.getLatLng());
                        } else {
                            map.removeLayer(marker);
                        }
                    }
                });

                if (visibleMarkers.length > 0) {
                    const bounds = L.latLngBounds(visibleMarkers);
                    map.fitBounds(bounds.pad(0.2));
                }
            }

            function findCardByCpId(cpId) {
                const cards = document.querySelectorAll('.cp-card');
                for (const card of cards) {
                    if (card.dataset && card.dataset.cpId === cpId) {
                        return card;
                    }
                }
                return null;
            }

            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    filterMapAndList(this.value);
                    if (clearSearch) {
                        clearSearch.style.display = (this.value || '').length > 0 ? 'block' : 'none';
                    }
                });
            }

            if (clearSearch) {
                clearSearch.addEventListener('click', function () {
                    if (searchInput) {
                        searchInput.value = '';
                        filterMapAndList('');
                        searchInput.focus();
                    }
                    clearSearch.style.display = 'none';
                });
            }

            if (listEl) {
                listEl.addEventListener('click', function (ev) {
                    const card = ev.target.closest('.cp-card');
                    if (!card || !card.dataset) return;
                    const cpId = card.dataset.cpId;
                    const marker = markerLookup[cpId];
                    if (!marker) return;
                    const latlng = marker.getLatLng();
                    map.flyTo([latlng.lat, latlng.lng], 16, { animate: true, duration: 0.45 });
                    marker.openPopup();
                });
            }

            function toggleMapSize() {
                const mapEl = document.getElementById('map');
                if (!mapEl) return;
                const expanded = mapEl.classList.toggle('expanded');
                if (mapExpandBtn) {
                    mapExpandBtn.textContent = expanded ? 'üó∫ Shrink' : 'üó∫ Expand';
                }
                requestAnimationFrame(() => map.invalidateSize());
            }

            function locateUser() {
                if (!navigator.geolocation) return;
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }
                    userMarker = L.circleMarker([lat, lng], {
                        radius: 7,
                        color: '#00d4aa',
                        fillColor: '#00d4aa',
                        fillOpacity: 0.9,
                        weight: 2
                    }).addTo(map);
                    map.flyTo([lat, lng], 15, { animate: true, duration: 0.45 });
                }, err => {
                    console.error('Public map: geolocation failed', err);
                }, { enableHighAccuracy: true, timeout: 10000 });
            }

            if (mapExpandBtn) {
                mapExpandBtn.addEventListener('click', toggleMapSize);
            }

            if (gpsBtn) {
                gpsBtn.addEventListener('click', locateUser);
            }

            const hasFiniteCoordinates = Object.keys(markerLookup).length > 0;
            if (!hasFiniteCoordinates) {
                console.error('Public map: no finite coordinates found in marker list.');
            }

            requestAnimationFrame(() => {
                map.invalidateSize();
                if (hasLocation.length > 0) {
                    const bounds = L.latLngBounds(hasLocation.map(p => [asNumber(pick(p, 'Latitude', 'latitude')), asNumber(pick(p, 'Longitude', 'longitude'))]));
                    map.fitBounds(bounds.pad(0.2));
                }
            });

            filterMapAndList('');
            window.addEventListener('resize', () => map.invalidateSize());
            }
        </script>
    }
</body>
</html>
